<?xml version="1.0"?>
<project name="Maven Build" default="maven:bundle">

    <property name="workspace.root" location=".." />
    <property name="impala.home" location="${workspace.root}/impala" />
    <import file="${impala.home}/properties-build.xml" />
    <import file="${impala.home}/tasks-build.xml" />
    
    <property name="maven.stage.location" location="${deploy.dir}/maven-stage"/>
    
    <target name="maven:bundle">
        <delete failonerror="false" dir="${maven.stage.location}"></delete>
        <mkdir dir = "${maven.stage.location}"/>

        <echo>Project version: ${project.version}</echo>
        
        <filterset id = "mavenFilter">
            <filter token="impala.version" value="${project.version}" />
            <filtersfile file = "${impala.home}/modules/filter.properties"/>
        </filterset>
        
        <copy todir="${maven.stage.location}" file="${impala.home}/maven/pom.xml" filtering="true">
            <filterset refid="mavenFilter"/>
        </copy>
        
        <jar destfile="${impala.home}/dist/impala-${project.version}-bundle.jar" basedir="${maven.stage.location}"/>

    </target>
    
    <target name="maven:publish-local">
        <!-- Copies created artifacts from dist directory to Maven publish directory.
        Also generates simple POMs for each artifact. 
        -->
        <mavenpublish 
            sourceDir = "${repository.dir}/dist" 
            artifacts = "${maven.artifacts}" 
            organisation = "org.impalaframework"
            destdir = "../maven/repo"/>
    </target>
    
</project>
