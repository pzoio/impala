<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" 
	   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
http://www.springframework.org/schema/beans 
http://www.springframework.org/schema/beans/spring-beans-2.0.xsd">

 <bean id="moduleManagementFacade" 
	 class="org.impalaframework.facade.DefaultModuleManagementFacade">
	 <property name="moduleOperationRegistry" ref="moduleOperationRegistry"/>
	 <property name="applicationContextLoader" ref="applicationContextLoader"/>
	 <property name="moduleLocationResolver" ref="moduleLocationResolver"/>
	 <property name="moduleLoaderRegistry" ref="moduleLoaderRegistry"/>
	 <property name="modificationExtractorRegistry" ref="modificationExtractorRegistry"/>
	 <property name="transitionProcessorRegistry" ref="transitionProcessorRegistry"/>
	 <property name="moduleStateHolder" ref="moduleStateHolder"/>
	 <property name="moduleStateChangeNotifier" ref="moduleStateChangeNotifier"/>
	 <property name="typeReaders" ref="typeReaders"/>
 </bean>

 <bean id="typeReaders" 
	 class = "org.impalaframework.module.type.TypeReaderRegistryFactoryBean">
 </bean>	
	
 <bean id="baseModuleOperation" abstract="true">
	 <property name="modificationExtractorRegistry" ref="modificationExtractorRegistry"/>
	 <property name="moduleStateHolder" ref="moduleStateHolder"/>
 </bean>
	 
 <bean id="addModuleOperation" 
	 class = "org.impalaframework.module.operation.AddModuleOperation"
	  parent = "baseModuleOperation">
 </bean>	
	 
 <bean id="closeRootModuleOperation" 
	 class = "org.impalaframework.module.operation.CloseRootModuleOperation"
	  parent = "baseModuleOperation">
 </bean>
	 
 <bean id="reloadNamedModuleOperation" 
	 class = "org.impalaframework.module.operation.ReloadNamedModuleOperation"
	  parent = "baseModuleOperation">
 </bean>
	 
 <bean id="removeModuleOperation" 
	 class = "org.impalaframework.module.operation.RemoveModuleOperation"
	  parent = "baseModuleOperation">
 </bean>	
	 
 <bean id="updateRootModuleOperation" 
	 class = "org.impalaframework.module.operation.UpdateRootModuleOperation"
	  parent = "baseModuleOperation">
 </bean>	
	 
 <bean id="reloadRootModuleOperation" 
	 class = "org.impalaframework.module.operation.ReloadRootModuleOperation"
	  parent = "baseModuleOperation">
 </bean>	
	 
 <bean id="incrementalUpdateRootModuleOperation" 
	 class = "org.impalaframework.module.operation.IncrementalUpdateRootModuleOperation"
	  parent = "baseModuleOperation">
 </bean>	
	 
 <bean id="reloadModuleNamedLikeOperation" 
	 class = "org.impalaframework.module.operation.ReloadModuleNamedLikeOperation"
	  parent = "baseModuleOperation">
	<property name="moduleOperationRegistry" ref="moduleOperationRegistry"/>
 </bean>	 		 	
	 
 <bean id="moduleOperationRegistry" class="org.impalaframework.module.operation.SimpleModuleOperationRegistry">
	<property name = "contributedOperations">
		<map>
			<entry key="addModuleOperation" value-ref="addModuleOperation"/>
			<entry key="closeRootModuleOperation" value-ref="closeRootModuleOperation"/>
			<entry key="reloadNamedModuleOperation" value-ref="reloadNamedModuleOperation"/>
			<entry key="removeModuleOperation" value-ref="removeModuleOperation"/>
			<entry key="updateRootModuleOperation" value-ref="updateRootModuleOperation"/>
			<entry key="reloadRootModuleOperation" value-ref="reloadRootModuleOperation"/>
			<entry key="incrementalUpdateRootModuleOperation" value-ref="incrementalUpdateRootModuleOperation"/>
			<entry key="reloadModuleNamedLikeOperation" value-ref="reloadModuleNamedLikeOperation"/>
		</map>
	</property> 
 </bean>
 
 <bean id="locationPropertiesResourceName" class="org.impalaframework.bean.SystemPropertyFactoryBean">
	  <property name="propertyName" value="bootstrapLocationsResource"/>
	  <property name="defaultValue" value="classpath:impala.properties"/>
  </bean>	
 	
  <bean id="locationProperties" class="org.impalaframework.bean.OptionalPropertiesFactoryBean">
	  <property name="location" ref="locationPropertiesResourceName"/>
  </bean>

 <bean id="moduleClassDirectory" class="org.impalaframework.bean.SystemPropertiesFactoryBean">
	 <property name="properties" ref="locationProperties"/>
	 <property name="propertyName" value="impala.module.class.dir"/>
	 <property name="defaultValue" value="bin"/>
 </bean>
	
 <bean id="moduleTestDirectory" class="org.impalaframework.bean.SystemPropertiesFactoryBean">
	 <property name="properties" ref="locationProperties"/>
	 <property name="propertyName" value="impala.module.test.dir"/>
	 <property name="defaultValue" value="bin"/>
 </bean>
	
 <bean id="workspaceRoot" class="org.impalaframework.bean.SystemPropertiesFactoryBean">
	 <property name="properties" ref="locationProperties"/>
	 <property name="propertyName" value="workspace.root"/>
	 <property name="defaultValue" value="../"/>
 </bean>
	
 <bean id="applicationVersion" class="org.impalaframework.bean.SystemPropertiesFactoryBean">
	 <property name="properties" ref="locationProperties"/>
	 <property name="propertyName" value="application.version"/>
 </bean>
	
 <bean id="moduleLocationResolver" class="org.impalaframework.resolver.SimpleModuleLocationResolver">
	 <property name="moduleClassDirectory" ref="moduleClassDirectory"/>
	 <property name="moduleTestDirectory" ref="moduleTestDirectory"/>
	 <property name="workspaceRoot" ref="workspaceRoot"/>
 </bean>

 <bean id="classLoaderFactory" class="org.impalaframework.classloader.ModuleClassLoaderFactory"/>
	
 <bean id="baseModuleLoader" abstract="true">
	 <property name = "classLoaderFactory" ref = "classLoaderFactory"/>
 </bean>		
	
 <bean id="rootModuleLoader" 
	 parent="baseModuleLoader"
	 class="org.impalaframework.module.loader.ManualReloadingRootModuleLoader">
	<constructor-arg ref="moduleLocationResolver"/>
 </bean>	
	
 <bean id="applicationModuleLoader" 
	 parent="baseModuleLoader"
	 class="org.impalaframework.module.loader.ApplicationModuleLoader">
	<constructor-arg ref="moduleLocationResolver"/>
 </bean>	
	
 <bean id="applicationBeansetModuleLoader" 
	 parent="baseModuleLoader"
	 class="org.impalaframework.module.loader.BeansetApplicationModuleLoader">
	<constructor-arg ref="moduleLocationResolver"/>
 </bean>	
 
 <bean id="serviceRegistry" class="org.impalaframework.service.registry.internal.ServiceRegistryImpl"/>
	
 <bean id="moduleLoaderRegistry" class="org.impalaframework.module.loader.ModuleLoaderRegistry">
	<property name = "moduleLoaders">
		<map>
			<entry key="root" value-ref="rootModuleLoader"/>
			<entry key="application" value-ref="applicationModuleLoader"/>
			<entry key="application_with_beansets" value-ref="applicationBeansetModuleLoader"/>
		</map>
	</property> 
 </bean>
	
 <bean id="applicationContextLoader" class="org.impalaframework.module.loader.DefaultApplicationContextLoader">
	<property name = "moduleLoaderRegistry" ref="moduleLoaderRegistry"/>	  
	<property name = "serviceRegistry" ref="serviceRegistry"/>	  
 </bean>
 
 <bean id="strictModificationExtractor" class="org.impalaframework.module.modification.StrictModificationExtractor"/>
	
 <bean id="stickyModificationExtractor" class="org.impalaframework.module.modification.StickyModificationExtractor"/>	
	
 <bean id="modificationExtractorRegistry" class="org.impalaframework.module.modification.ModificationExtractorRegistry">
	<property name = "modificationExtractorMap">
		<map>
			<entry key="strict" value-ref="strictModificationExtractor"/>
			<entry key="sticky" value-ref="stickyModificationExtractor"/>
		</map>
	</property> 
 </bean>	
	
 <bean id="loadTransitionProcessor" class="org.impalaframework.module.transition.LoadTransitionProcessor">
	<constructor-arg ref="applicationContextLoader"/>	 
 </bean>
	
 <bean id="unloadTransitionProcessor" class="org.impalaframework.module.transition.UnloadTransitionProcessor"/>	
	
 <bean id="addLocationsTransitionProcessor" class="org.impalaframework.module.transition.AddLocationsTransitionProcessor">
	<constructor-arg ref="moduleLoaderRegistry"/>	 
 </bean>	
	
 <bean id="transitionProcessorRegistry" class="org.impalaframework.module.transition.TransitionProcessorRegistry">
	<property name = "transitionProcessorMap">
		<map>
			<entry key="UNLOADED_TO_LOADED" value-ref="loadTransitionProcessor"/>
			<entry key="LOADED_TO_UNLOADED" value-ref="unloadTransitionProcessor"/>
			<entry key="CONTEXT_LOCATIONS_ADDED" value-ref="addLocationsTransitionProcessor"/>
		</map>
	</property> 
 </bean>
	
 <bean id="moduleStateChangeNotifier" class="org.impalaframework.module.holder.DefaultModuleStateChangeNotifier"/>
	
 <bean id="moduleStateHolder" class="org.impalaframework.module.holder.DefaultModuleStateHolder">
	<property name="transitionProcessorRegistry" ref="transitionProcessorRegistry"/>	 
	<property name="moduleStateChangeNotifier" ref="moduleStateChangeNotifier"/>	   
 </bean>

</beans>