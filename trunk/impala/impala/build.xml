<?xml version="1.0"?>
<project name="Main Impala build file" basedir="." default="all">
		
	<property name = "workspace.root" location = ".."/>
	<property name = "impala.home" location = "${workspace.root}/impala"/>
	
	<!-- this is needed for some of the imported targets -->
	<mkdir dir = "${impala.home}/lib"/>
	
	<property name = "deployable.project.list" value = "impala-core,impala-command,impala-jmx,impala-build,impala-interactive,impala-web"/>	
	<property name = "project.list" value = "${deployable.project.list},sample-module1,sample-module2,sample-module3,sample-module4"/>
	<import file="shared-build.xml" />
	<import file="tasks-build.xml" />
	<import file="dist-build.xml" />
	
	<!-- ######################## Main Targets #######################-->
	
	<target name = "build"
		description="Bootstrap build command, used to create other tasks used in build process">
		<ant antfile="build.xml" dir = "../impala-build" target = "project:clean" inheritall = "false"/>
		<ant antfile="build.xml" dir = "../impala-build" target = "project:jar" inheritall = "false"/>
		<ant antfile="build.xml" dir = "../impala-build" target = "project:repo" inheritall = "false"/>
	</target>
	
	<target name = "clean"
		description="Removes Impala jars from ${impala.home}/lib and to local Impala repository ${repository.dir}">
		<delete failonerror = "false" dir = "${deploy.dir}"/>
		<delete failonerror = "false" dir = "${impala.home}/lib"/>
		<delete failonerror = "false">
			<fileset  dir = "${repository.dir}" includes="**/impala*.jar"/>
		</delete>
		<mkdir dir = "${impala.home}/lib"/>
		<mkdir dir = "${deploy.dir}"/>
	</target>
	
	<target name = "test" 
		depends = "shared:test"
		description="Runs tests for all Impala projects"/>
	
	<target name = "get" 
		depends = "shared:get"
		description="Downloads dependencies for all Impala projects"/>
		
	<target name = "launcher" 
		description="Runs the launcher">
		<ant antfile="build.xml" dir = "../impala-launcher" target = "launcher:jar" inheritall = "false"/>
		<ant antfile="build.xml" dir = "../impala-launcher" target = "launcher:repo" inheritall = "false"/>
	</target>
	
	<target name = "make" 
		depends = "shared:all-no-test, launcher, copy"
		description="Builds Impala jars and adds them to ${impala.home}/lib and to local Impala repository ${repository.dir}"/>
	
	<target name = "dist" 
		description="Builds the releasable distribution"
		depends = "dist:dist">
	</target>
	
	<target name = "tohome" 
		depends = "all"
		description="Builds Impala directly into the IMPALA_HOME location">
		<ant antfile="dist-build.xml" dir = "./" target = "dist:dist-to-home" inheritall = "false">
			<property name = "impala.home" value = "./"/>
		</ant>
	</target>	
	
	<target name = "newproject" 
		description="Creates a new project structure"
		depends = "inpalaversion">
		<!-- TODO should be able to figure this out dynamically. Also, check IMPALA_HOME is set -->
		<echo>Creating new project structure, Impala version '${impala.version}</echo>
		<ant antfile="scaffold-build.xml" dir = "./" target = "scaffold:create" inheritall = "false">
			<property name = "impala.home" value = "./"/>
			<property name = "project.version" value = "impala.version"/>
		</ant>
	</target>
	
	<target name = "newmodule" 
		description="Creates a new module"
		depends = "inpalaversion">
		<!-- TODO should be able to figure this out dynamically. Also, check IMPALA_HOME is set -->
		<echo>Creating new module, Impala version: ${impala.version}</echo>
		<ant antfile="scaffold-build.xml" dir = "./" target = "scaffold:newmodule" inheritall = "false">
			<property name = "impala.home" value = "./"/>
			<property name = "project.version" value = "impala.version"/>
		</ant>
	</target>
	
	<target name = "release"
		description="Builds and tags project using the property 'next.release.version' in release-build.properties">
		<ant antfile="release-build.xml" dir = "./" target = "release" inheritall = "false"/>
	</target>	
	
	<target name = "all" 
		depends = "build, clean, build, make, launcher, dist"
		description="Bootstraps, cleans and builds jars (build, clean, make, launcher, dist)"/>
	
	<!-- ######################## Helper targets #######################-->
	
	<target name = "inpalaversion">
		<input addproperty="impala.version" defaultvalue="SNAPSHOT" message="Please specify Impala version in IMPALA_HOME"/>
	</target>	
	
	<target name = "copy">
		<mkdir dir="${impala.home}/lib"/>
		<copy todir="${impala.home}/lib" flatten="true">
			<fileset dir="${repository.dir}/dist" 
				includes=
				"**/*.jar"/>
		</copy>
	</target>
	
</project>