<?xml version="1.0"?>
<project name="Scaffold Build">

	<property name="workspace.root" location=".." />
	<property name="impala.home" location="${workspace.root}/impala" />

	<echo level="debug">Using impala home: ${impala.home}</echo>

	<import file="${impala.home}/properties-build.xml" />
	<import file="${impala.home}/classpath-build.xml" />

	<target name="scaffold:input-main-project" unless="main.project.name">
		<input message="Please enter main project name, to be used for root module:" addproperty="main.project.name" />
	</target>

	<target name="scaffold:input-module-project" unless="module.project.name">
		<input message="Please enter name of first non-root module:" addproperty="module.project.name" />
	</target>

	<target name="scaffold:input-web-project" unless="web.project.name">
		<input message="Please enter name of web module:" addproperty="web.project.name" />
	</target>	
	
	<target name="scaffold:input-test-project" unless="test.project.name">
		<input message="Please enter name of tests project:" addproperty="test.project.name" />
	</target>

	<target name="scaffold:input-repository-project" unless="repository.project.name">
		<input message="Please enter name of repository project:" addproperty="repository.project.name" />
	</target>

	<target name="scaffold:input-workspace-root" unless="workspace.root.location.input">
		<input message="Please enter name of workspace root directory:" addproperty="workspace.root.location.input" />
	</target>
	
	<!--
	Scaffold steps for initial project creation:
	- run ant -f scaffold-build.xml scaffold:create
	- check IMPALA_HOME is set correctly
	- then to main project, and run ant fetch, ant get
	- open eclipse in workspace root
	- import all projects
	Then
	- run tests individually as JUnit 
	- run test individually interactively
	- run AllTests
	- run StartServer (connect using http://localhost:8080/web/message.htm)
	-->
	<target name="scaffold:create-confirm" depends="scaffold:input-workspace-root,
								scaffold:input-main-project,
								scaffold:input-module-project,
								scaffold:input-web-project,
								scaffold:input-test-project,
								scaffold:input-repository-project">
		<property name="workspace.root.location" location="${workspace.root.location.input}" />

		<echo>Workspace root location: ${workspace.root.location}</echo>
		<echo>Main (root) project name: ${main.project.name}</echo>
		<echo>First non-root module project name: ${module.project.name}</echo>
		<echo>Web project name: ${web.project.name}</echo>
		<echo>Tests project name: ${test.project.name}</echo>
		<echo>Repository project name: ${repository.project.name}</echo>

		<!-- FIXME offer better mechanism for continuing-->
		<input message="Press return key to continue, or CTRL + C to quit ..." />
		
		<property name = "copy.main.project" value = "true"/>
		<property name = "copy.module.project" value = "true"/>
		<property name = "copy.web.project" value = "true"/>
		
		<mkdir dir="${workspace.root.location}" />
	</target>
	
	<target name="scaffold:filterset">
		
		<filterset id = "scaffoldFilter">
			<filter token="main.project.name" value="${main.project.name}" />
			<filter token="module.project.name" value="${module.project.name}" />
			<filter token="web.project.name" value="${web.project.name}" />
			<filter token="test.project.name" value="${test.project.name}" />
			<filter token="repository.project.name" value="${repository.project.name}" />
			<filter token="impala.version" value="${project.version}" />
			<filtersfile file = "${impala.home}/scaffold/filter.properties"/>
		</filterset>
		
	</target>	
	
	<target name="scaffold:copymain" if = "copy.main.project">
		
		<copy todir="${workspace.root.location}/${main.project.name}" filtering="true">
			<fileset dir="${impala.home}/scaffold/main">
			</fileset>
			<filterset refid="scaffoldFilter"/>
		</copy>		
		<copy todir="${workspace.root.location}/${main.project.name}" filtering="true">
			<fileset dir="${impala.home}/scaffold/java/main"/>
			<filterset refid="scaffoldFilter"/>
		</copy>
		<copy file = "${impala.home}/scaffold/spring/parent-context.xml" 
			tofile="${workspace.root.location}/${main.project.name}/spring/parent-context.xml"
			filtering="true">
			<filterset refid="scaffoldFilter"/>
		</copy>
		
	</target>	
		
	<target name="scaffold:copymodule" if = "copy.module.project">
		
		<copy todir="${workspace.root.location}/${module.project.name}" filtering="true">
			<fileset dir="${impala.home}/scaffold/module">
			</fileset>
			<filterset refid="scaffoldFilter"/>
		</copy>	
		<copy todir="${workspace.root.location}/${module.project.name}" filtering="true">
			<fileset dir="${impala.home}/scaffold/java/module"/>
			<filterset refid="scaffoldFilter"/>
		</copy>
		<copy file = "${impala.home}/scaffold/spring/module-context.xml" 
			tofile="${workspace.root.location}/${module.project.name}/spring/${module.project.name}-context.xml"
			filtering="true">
			<filterset refid="scaffoldFilter"/>
		</copy>
		
	</target>
	
	<target name="scaffold:copyweb" if = "copy.web.project">
		
		<copy todir="${workspace.root.location}/${web.project.name}" filtering="true">
			<fileset dir="${impala.home}/scaffold/web">
			</fileset>
			<filterset refid="scaffoldFilter"/>
		</copy>		
		<copy todir="${workspace.root.location}/${web.project.name}" filtering="true">
			<fileset dir="${impala.home}/scaffold/java/web"/>
			<filterset refid="scaffoldFilter"/>
		</copy>
		<copy file = "${impala.home}/scaffold/spring/web-context.xml" 
			tofile="${workspace.root.location}/${web.project.name}/spring/${web.project.name}-context.xml"
			filtering="true">
			<filterset refid="scaffoldFilter"/>
		</copy>
		
	</target>
			
	<target name="scaffold:create" depends="
		scaffold:create-confirm, 
		scaffold:filterset, 
		scaffold:copymain, 
		scaffold:copymodule, 
		scaffold:copyweb">
		
		<copy todir="${workspace.root.location}/${test.project.name}" filtering="true">
			<fileset dir="${impala.home}/scaffold/test">
			</fileset>
			<filterset refid="scaffoldFilter"/>
		</copy>		
		<copy todir="${workspace.root.location}/${test.project.name}" filtering="true">
			<fileset dir="${impala.home}/scaffold/java/test"/>
			<filterset refid="scaffoldFilter"/>
		</copy>

		<copy todir="${workspace.root.location}/${repository.project.name}" filtering="true">
			<fileset dir="${impala.home}/scaffold/repository">
			</fileset>
			<filterset refid="scaffoldFilter"/>
		</copy>
	</target>

</project>