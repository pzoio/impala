<?xml version="1.0"?>
<project name="Scaffold Build">

	<property name="workspace.root" location=".." />
	<property name="impala.home" location="${workspace.root}/impala" />

	<echo level="debug">Using impala home: ${impala.home}</echo>

	<import file="${impala.home}/properties-build.xml" />
	<import file="${impala.home}/classpath-build.xml" />
	
	<!-- ###################### input targets for creating new project structure ###################### -->

	<target name="scaffold:input-main-project" unless="main.project.name">
		<input message="Please enter main project name, to be used for root module:" addproperty="main.project.name" defaultvalue="main"/>
	</target>

	<target name="scaffold:input-module-project" unless="module.project.name">
		<input message="Please enter name of first non-root module:" addproperty="module.project.name" defaultvalue="module1" />
	</target>

	<target name="scaffold:input-web-project" unless="web.project.name">
		<input message="Please enter name of web module:" addproperty="web.project.name" defaultvalue="web" />
	</target>	
	
	<target name="scaffold:input-test-project" unless="test.project.name">
		<input message="Please enter name of tests project:" addproperty="test.project.name" defaultvalue="test" />
	</target>

	<target name="scaffold:input-repository-project" unless="repository.project.name">
		<input message="Please enter name of repository project:" addproperty="repository.project.name" defaultvalue="repository" />
	</target>

	<target name="scaffold:input-workspace-root" unless="workspace.root.location.input">
		<property name="default.workspace.root" location="${user.home}/workspaces/newproject"/>
		<input message="Please enter name of workspace root directory:" addproperty="workspace.root.location.input" defaultvalue="${default.workspace.root}"/>
	</target>
	
	<!--
	Scaffold steps for initial project creation:
	- run ant -f scaffold-build.xml scaffold:create
	- check IMPALA_HOME is set correctly
	- then to main project, and run ant fetch, ant get
	- open eclipse in workspace root
	- import all projects
	Then
	- run tests individually as JUnit 
	- run test individually interactively
	- run AllTests
	- run StartServer (connect using http://localhost:8080/web/message.htm)
	-->
	<target name="scaffold:newproject-confirm" depends="scaffold:input-workspace-root,
								scaffold:input-main-project,
								scaffold:input-module-project,
								scaffold:input-web-project,
								scaffold:input-test-project,
								scaffold:input-repository-project">
		<property name="workspace.root.location" location="${workspace.root.location.input}" />

		<echo>Workspace root location: ${workspace.root.location}</echo>
		<echo>Main (root) project name: ${main.project.name}</echo>
		<echo>First application module project name: ${module.project.name}</echo>
		<echo>Web project name: ${web.project.name}</echo>
		<echo>Tests project name: ${test.project.name}</echo>
		<echo>Repository project name: ${repository.project.name}</echo>

		<!-- FIXME offer better mechanism for continuing-->
		<input message="Press return key to continue, or CTRL + C to quit ..." />
		
		<property name = "copy.main.project" value = "true"/>
		<property name = "copy.module.project" value = "true"/>
		<property name = "copy.web.project" value = "true"/>
		
		<mkdir dir="${workspace.root.location}" />
	</target>

	<!--######################  input targets for creating new single module ###################### -->

	<target name="scaffold:input-new-project" unless="new.project.name">
		<input message="Please enter name of new module:" addproperty="new.project.name" />
	</target>
	
	<target name="scaffold:input-parent-project" unless="parent.project.name">
		<input message="Please enter name of parent module. If not sure, enter the name of the root module:" addproperty="main.project.name" />
	</target>
	
	<target name="scaffold:input-project-type-name" unless="project.type.name">
		<input message="Please enter type or project:" addproperty="project.type.name" validargs="web,application" />
		<property name = "${project.type.name}.project.name" value = "${new.project.name}"/>
		<property name = "copy.${project.type.name}.project" value = "true"/>
	</target>	
	
	<target name="scaffold:newmodule-confirm" depends="
								scaffold:input-workspace-root,
								scaffold:input-parent-project,
								scaffold:input-new-project,
								scaffold:input-project-type-name,
								scaffold:input-repository-project">
		<property name="workspace.root.location" location="${workspace.root.location.input}" />

		<echo>About to create new module of type '${project.type.name}' with name '${new.project.name}' create in ${workspace.root.location}</echo>
		<echo>Repository project name: ${repository.project.name}</echo>

		<!-- FIXME offer better mechanism for continuing-->
		<input message="Press return key to continue, or CTRL + C to quit ..." />
		
	</target>
	
	<!-- ######################  filterset declaration ###################### -->
	
	<target name="scaffold:filterset">
		
		<filterset id = "scaffoldFilter">
			<filter token="main.project.name" value="${main.project.name}" />
			<filter token="module.project.name" value="${module.project.name}" />
			<filter token="web.project.name" value="${web.project.name}" />
			<filter token="test.project.name" value="${test.project.name}" />
			<filter token="repository.project.name" value="${repository.project.name}" />
			<filter token="impala.version" value="${project.version}" />
			<filtersfile file = "${impala.home}/modules/filter.properties"/>
		</filterset>
		
	</target>	
	
	<!--######################  copy targets ###################### -->
	
	<target name="scaffold:copymain" if = "copy.main.project">
		
		<available file="${workspace.root.location}/${main.project.name}" property="main.already.exists"/>
		<fail if="main.already.exists" message="The location ${workspace.root.location}/${main.project.name} already exists"/>
		
		<copy todir="${workspace.root.location}/${main.project.name}" filtering="true">
			<fileset dir="${impala.home}/modules/main">
			</fileset>
			<filterset refid="scaffoldFilter"/>
		</copy>
		
	</target>	
		
	<target name="scaffold:copymodule" if = "copy.module.project">
		
		<available file="${workspace.root.location}/${main.project.name}" property="main.already.exists"/>
		<fail unless="main.already.exists" message="The parent location ${workspace.root.location}/${main.project.name} does not exist. Cannot use this as a parent module."/>
		
		<available file="${workspace.root.location}/${module.project.name}" property="module.already.exists"/>
		<fail if="module.already.exists" message="The location ${workspace.root.location}/${module.project.name} already exists. You probably already have a module at this location."/>
		
		<copy todir="${workspace.root.location}/${module.project.name}" filtering="true">
			<fileset dir="${impala.home}/modules/application" excludes= "**/module-context.xml">
			</fileset>
			<filterset refid="scaffoldFilter"/>
		</copy>
	
		<copy file = "${impala.home}/modules/application/resources/module-context.xml" 
				tofile="${workspace.root.location}/${module.project.name}/resources/${module.project.name}-context.xml"
				filtering="true">
			<filterset refid="scaffoldFilter"/>
		</copy>
		
	</target>
	
	<target name="scaffold:copyweb" if = "copy.web.project">

		<available file="${workspace.root.location}/${main.project.name}" property="main.already.exists"/>
		<fail unless="main.already.exists" message="The parent location ${workspace.root.location}/${main.project.name} does not exist. Cannot use this as a parent module."/>
			
		<available file="${workspace.root.location}/${web.project.name}" property="web.already.exists"/>
		<fail if="web.already.exists" message="The location ${workspace.root.location}/${web.project.name} already exists. You probably already have a module at this location."/>
		
		<copy todir="${workspace.root.location}/${web.project.name}" filtering="true">
			<fileset dir="${impala.home}/modules/web" excludes = "**/module-context.xml">
			</fileset>
			<filterset refid="scaffoldFilter"/>
		</copy>
	
		<copy file = "${impala.home}/modules/web/resources/module-context.xml" 
				tofile="${workspace.root.location}/${web.project.name}/resources/${web.project.name}-context.xml"
				filtering="true">
			<filterset refid="scaffoldFilter"/>
		</copy>
		
	</target>
	
	
	<target name="scaffold:copytest">
		
		<copy todir="${workspace.root.location}/${test.project.name}" filtering="true">
			<fileset dir="${impala.home}/modules/test">
			</fileset>
			<filterset refid="scaffoldFilter"/>
		</copy>	
		
	</target>
	
	
	<target name="scaffold:copyrepository">
	
		<copy todir="${workspace.root.location}/${repository.project.name}" filtering="true">
			<fileset dir="${impala.home}/modules/repository">
			</fileset>
			<filterset refid="scaffoldFilter"/>
		</copy>
	
	</target>

	<!--######################  high level targets ###################### -->
			
	<target name="scaffold:create" depends="
		scaffold:newproject-confirm, 
		scaffold:filterset, 
		scaffold:copymain, 
		scaffold:copymodule, 
		scaffold:copyweb,
		scaffold:copytest,
		scaffold:copyrepository">
	</target>
	
	<target name="scaffold:newmodule" depends="
		scaffold:newmodule-confirm, 
		scaffold:filterset, 
		scaffold:copymodule, 
		scaffold:copyweb">
	</target>

</project>