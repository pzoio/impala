#summary Getting started, part four - understanding a web application

= Impala web application =

An important feature of Impala is support for web development. An important requirement of any web development environment is a fast turnaround time between making changes and seeing the displayed in your browser. Impala provides this through it's dynamic module loading capability. Of course, Impala allows for modular web application. Event the web portion of an application can be modularised, by allowing each Servlet to be represented by a separate module. 

Apart from these capabilities, a Spring MVC web application will look no different from a typical web application, since it uses an otherwise identical programming model. 

We'll take a look at how Impala supports web applications next.

== Web project ==

Java web projects are packaged in a well known structure with a web context root directory, a _WEB-INF_ subdirectory, etc. The structure of an Impala web project is shown below:

http://impala.googlecode.com/svn/wiki/images/getting_started_web.png

The _context_ folder contains the web context root. The one other difference in terms of file structure is in the _webconfig_ folder, which is also a Java source folder in Eclipse.
The contents of this folder are described in a bit more detail below.

=== web.xml ===

A file which is contained in practically every web application is the _web.xml_ descriptor. This file contains servlets definitions, servlet configuration parameters, filter definitions, and web application life cycle listeners. Lets take a look at the Impala _web.xml_ created for us in [GettingStartedPart1 part one].  

{{{
<web-app>
    
    <display-name>Enter display name here</display-name>

    <description>Enter description here</description>
    
    <context-param>
        <param-name>contextLoaderClassName</param-name>
        <param-value>org.impalaframework.web.spring.loader.ExternalModuleContextLoader</param-value>
    </context-param>

    <listener>
        <listener-class>org.impalaframework.web.spring.loader.ImpalaContextLoaderListener</listener-class>
    </listener>
    
    <servlet>
        <servlet-name>myapp-web</servlet-name>
        <servlet-class>org.impalaframework.web.spring.servlet.ExternalModuleServlet</servlet-class>
        <load-on-startup>1</load-on-startup>
    </servlet>

    <servlet-mapping>
        <servlet-name>myapp-web</servlet-name>
        <url-pattern>*.htm</url-pattern>
    </servlet-mapping>

    <session-config>
        <session-timeout>10</session-timeout>
    </session-config>

    <welcome-file-list>
        <welcome-file>index.jsp</welcome-file>
    </welcome-file-list>
    
</web-app>
}}}

In a plain Spring MVC based web application, the Spring application context which backs the application is loaded via a `ServletContextListener` class called `ContextLoaderListener`. 
Impala's analogue is `ImpalaContextLoaderListener`, which extends `ContextLoaderListener` to initialise the Impala environment.

Spring MVC applications are usually exposed via the servlet `org.springframework.web.servlet.DispatcherServlet`, or a subclass of this class. 
Impala provides a number of subclasses of `DispatcherServlet`, but the favoured implementation is `ExternalModuleServlet`.

`ExternalModuleServlet` is so named because it provides a means by which the module definitions which comprise an Impala application are not defined within the _web.xml_ descriptor. 
In fact, this reflects a deliberate strategy to keep as little configuration in _web.xml_ for the reason that _web.xml_ cannot be reloaded without reloading the entire application.

=== Module definitions === 

The recommended approach to creating modules is to use self contained modules. The _moduledefinitions.xml_ is shown below.

{{{
<parent>
    <names>
    myapp-main
    myapp-module1
    myapp-web
    </names>
</parent>
}}}

It is possible to override the definition for specific modules. See [ModuleConfiguration module configuration] for more details.

=== Spring config file ===

The discussion in the previous section covers some Impala specific aspects of the web application. Next, we cover other elements of the web application, starting with the Spring configuration file for the web module. Spring users will note that the rest of the application is no different from the a typical Spring MVC application, reflecting the fact that Impala does not change the Spring application programming model in any way. 

Here's the Spring configuration file. It consists simply of a `ViewResolver` and `HandlerMapping` bean definitions, as well as a controller bean definition (`MessageController`).  
Recall from the discussion in [GettingStartedPart2 part two] that the sample application is really just a glorified "Hello World" application. The single dependency of the controller is the `MessageService` instance.

{{{
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" 
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"       
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.0.xsd">

    <bean name="/message.htm" class="com.application.web.MessageController">
        <property name = "messageService" ref = "messageService"/>
    </bean>    
    <bean id="handlerMapping" class="org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping"/>
    <bean id="jspViewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
          <property name="suffix" value=".jsp"/>
    </bean>
</beans>
}}}

We'll see shortly how the controller can be updated on the fly in a web container without having to redeploy the full application.

=== Web controller implementation ===

Next we take a look at the implemention of `MessageController`, which simply has the responsibility of exposing the message provided by the `MessageService` as a web model attribute, and for selecting a view. Based on the `ViewResolver` being used in our Spring web context definition, the view name `test` is translated to a JSP file named `test.jsp`.

{{{
package web;

import java.util.HashMap;

import interfaces.MessageService;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.mvc.Controller;

public class MessageController  implements Controller {
    private MessageService messageService;

    public void setMessageService(MessageService messageService) {
        this.messageService = messageService;
    }

    public ModelAndView handleRequest(HttpServletRequest arg0,
            HttpServletResponse arg1) throws Exception {
        HashMap<String, String> map = new HashMap<String, String>();
        map.put("message", messageService.getMessage());

        ModelAndView mav = new ModelAndView("test", map);
        return mav;
    }
}
}}}

=== JSP implementation ===

We complete our application by showing the rather trivial JSP used to output the message provided by the `MessageService`.

{{{
<html>
<head>
</head>
<body>
<b>A message from message service:</b> <%=request.getAttribute("message")%><br/>
</body>
</html>
}}}

== Running the web application ==

An important feature of Impala's web support is in the fact that you don't need to create a WAR file, or run an ANT build script, to deploy your web application in a development environment. In fact, you don't need to do anything apart from running up a Java main class generated as part of the quickstart application. 

Using CTRL-Shift + T, find the class `StartServer`. Right click, then select Run As ... Java Application.

This will start a Jetty Server and run up a server on port 8080.

The text shown on the console view of Eclipse will look something like this:

{{{
2009-02-03 21:37:18.224::INFO:  Logging to STDERR via org.mortbay.log.StdErrLog
2009-02-03 21:37:18.289::INFO:  jetty-6.1.1
2009-02-03 21:37:18.716:/web:INFO:  Initializing Spring root WebApplicationContext
INFO : BaseLocationsRetriever - org.impalaframework.bootstrap.ConfigurationSettings@76484e
Context locations: [META-INF/impala-bootstrap.xml, META-INF/impala-web-bootstrap.xml, META-INF/impala-graph-bootstrap.xml, META-INF/impala-jmx-bootstrap.xml, META-INF/impala-web-listener-bootstrap.xml]
Property settings: 
  all.locations: [null]
  auto.reload.check.delay: 10 (default)
  auto.reload.check.interval: 2 (default)
  auto.reload.modules: true
  auto.reload.monitoring.type: default (default)
  classloader.type: graph (default)
  embedded.mode: true
  expose.jmx.operations: true (default)
  expose.mx4j.adaptor: false (default)
  extra.locations: [null]
  graph.bean.visibility.type: graphOrdered (default)
  jmx.locate.existing.server: false (default)
  module.class.dir: bin (default)
  module.resource.dir: resources (default)
  parent.classloader.first: false (default)
  partitioned.servlet.context: true (default)
  preserve.session.on.reload.failure: true (default)
  proxy.allow.no.service: false (default)
  proxy.missing.service.retry.count: 0 (default)
  proxy.missing.service.retry.interval: 1000 (default)
  proxy.set.context.classloader: true (default)
  session.module.protection: true
  spring.path.mapping.enabled: false (default)
  touch.file: /WEB-INF/modules/touch.txt (default)
  use.touch.file: false (default)
  workspace.root: ../ (default)
--------
INFO : BaseLocationsRetriever - Property source: org.impalaframework.config.PrefixedCompositePropertySource@7e319a - propertySources: [org.impalaframework.config.SystemPropertiesPropertySource@ea763a, org.impalaframework.config.StaticPropertiesPropertySource@f7dbd8, org.impalaframework.web.config.ServletContextPropertySource@824d2c]
INFO : BaseImpalaContextLoader - Impala context locations: [META-INF/impala-bootstrap.xml, META-INF/impala-web-bootstrap.xml, META-INF/impala-graph-bootstrap.xml, META-INF/impala-jmx-bootstrap.xml, META-INF/impala-web-listener-bootstrap.xml]
INFO : BaseImpalaContextLoader - Loading bootstrap context from locations [META-INF/impala-bootstrap.xml, META-INF/impala-web-bootstrap.xml, META-INF/impala-graph-bootstrap.xml, META-INF/impala-jmx-bootstrap.xml, META-INF/impala-web-listener-bootstrap.xml]
INFO : ScheduledModuleChangeMonitor - Starting org.impalaframework.module.monitor.ScheduledModuleChangeMonitorBean with fixed delay of 2 and interval of 10
INFO : LoadTransitionProcessor - Loading definition myapp-main
INFO : DefaultModuleRuntimeManager - Loading definition myapp-main
INFO : ScheduledModuleChangeMonitor - Monitoring for changes in module myapp-main: [file [/Users/philzoio/workspaces/newproject/myapp-web/../myapp-main/bin], file [/Users/philzoio/workspaces/newproject/myapp-web/../myapp-main/resources]]
INFO : LoadTransitionProcessor - Loading definition myapp-module1
INFO : DefaultModuleRuntimeManager - Loading definition myapp-module1
INFO : ModuleContributionPostProcessor - Contributing bean messageService from module myapp-module1
INFO : ScheduledModuleChangeMonitor - Monitoring for changes in module myapp-module1: [file [/Users/philzoio/workspaces/newproject/myapp-web/../myapp-module1/bin], file [/Users/philzoio/workspaces/newproject/myapp-web/../myapp-module1/resources]]
INFO : LoadTransitionProcessor - Loading definition myapp-web
INFO : DefaultModuleRuntimeManager - Loading definition myapp-web
INFO : ScheduledModuleChangeMonitor - Monitoring for changes in module myapp-web: [file [/Users/philzoio/workspaces/newproject/myapp-web/../myapp-web/bin], file [/Users/philzoio/workspaces/newproject/myapp-web/../myapp-web/resources]]
2009-02-03 21:37:20.206:/web:INFO:  Initializing Spring FrameworkServlet 'myapp-web'
INFO : ExternalModuleServlet - FrameworkServlet 'myapp-web': initialization started
INFO : ExternalModuleServlet - FrameworkServlet 'myapp-web': initialization completed in 21 ms
2009-02-03 21:37:20.246::INFO:  Started SelectChannelConnector @ 0.0.0.0:8080
}}}

You can connect to the server using the URL, assuming of course that you are connecting from the same machine:

{{{
http://localhost:8080/web/message.htm
}}}

http://impala.googlecode.com/svn/wiki/images/scaffold_message.jpg

=== Dynamic application updates ===

Note that Impala is started up to automatically detect changes in your modules, and reload modules in response to these changes. You can play with this mechanism by making changes to classes such as `MessageController` (in the web project) and `MessageServiceImpl` (in the module project).

So how does all this work? Impala is very flexible in supporting different startup configurations. When `ImpalaContextLoaderListener` is invoked on application startup, a bootstrap Spring context is created. This Spring context is not the application's Spring context. Instead, it is an `ApplicationContext` which reflects the Spring wiring for Impala itself.

We'll understand this better when considering the `StartServer` class used to run up Jetty in the previous section.

{{{
public class StartServer {
    public static void main(String[] args) {
        System.setProperty(WebConstants.BOOTSTRAP_LOCATIONS_RESOURCE_PARAM, "classpath:impala-embedded.properties");
        StartJetty.main(new String[]{"8080", "../myapp-web/context", "/web"});
    }
}
}}}

The system property `WebConstants.BOOTSTRAP_LOCATIONS_RESOURCE_PARAM` identifies a property file which is used to bootstrap Impala. 

The content of the default _impala-embedded.properties_ is shown below.

{{{
embedded.mode=true
#Automatically detect changes and reload modules
auto.reload.modules=true
#Maintain session objects across module reloads
session.module.protection=true
}}}

ADD LINK TO CONFIGURATION

Apart from the initial setup, we've done just about all our work in the IDE. In [GettingStartedPart5 part five] we show you how deploy an Impala-based application to Tomcat using the built-in ANT support.